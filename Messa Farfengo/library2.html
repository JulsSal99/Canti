let isZoomed = false;
let imageDragging = false;
let initialX;
let initialY;

function toggleZoom() {
    const overlayImg = document.getElementById("overlayImg");
    const zoomButton = document.querySelector(".zoom-button");

    if (!isZoomed) {
        isZoomed = true;
        overlayImg.style.cursor = "move";
        zoomButton.textContent = "Normale";
        overlayImg.addEventListener("mousedown", startDragging);
        overlayImg.addEventListener("mouseup", stopDragging);
    } else {
        isZoomed = false;
        overlayImg.style.cursor = "default";
        zoomButton.textContent = "Lente";
        overlayImg.removeEventListener("mousedown", startDragging);
        overlayImg.removeEventListener("mouseup", stopDragging);
        resetImagePosition();
    }
}

function startDragging(event) {
    imageDragging = true;
    initialX = event.clientX;
    initialY = event.clientY;
}

function stopDragging() {
    imageDragging = false;
}

function handleMouseMove(event) {
    if (isZoomed && imageDragging) {
        const overlayImg = document.getElementById("overlayImg");
        const offsetX = event.clientX - initialX;
        const offsetY = event.clientY - initialY;
        initialX = event.clientX;
        initialY = event.clientY;
        overlayImg.style.left = `${overlayImg.offsetLeft + offsetX}px`;
        overlayImg.style.top = `${overlayImg.offsetTop + offsetY}px`;
    }
}

function resetImagePosition() {
    const overlayImg = document.getElementById("overlayImg");
    overlayImg.style.left = "50%";
    overlayImg.style.top = "50%";
}

function openOverlay(images, index, groupName) {
    abilitaNavigazioneFrecce();
    const overlay = document.getElementById("overlay");
    const overlayImg = document.getElementById("overlayImg");
    const spanElement = document.querySelector("span.pagenum");
    spanElement.textContent = "[" + imageGroups[groupName].length + "] " + groupName;
    overlay.style.display = "block";
    overlayImg.src = thumbnailsPath + images[index];
    overlayImg.dataset.group = JSON.stringify(images);
    overlayImg.dataset.index = index;
    groupTitle.textContent = groupName;
    document.getElementById("imageContainer").appendChild(groupTitle);
    document.getElementById("imageContainer").appendChild(document.createElement("br"));
    handleIMGsize();
    if (isZoomed) {
        toggleZoom(); // Disattiva la lente quando si apre un nuovo overlay
    }
}

function closeOverlay() {
    document.getElementById("overlay").style.display = "none";
    const pageTitle = document.querySelector("#imageContainer h3");
    const groupTitle = document.querySelector("#imageContainer h3 + h3");
    if (pageTitle) pageTitle.remove();
    if (groupTitle) groupTitle.remove();
    const firstGroupName = Object.keys(imageGroups)[0];
    document.querySelector(".image-group h2").textContent = firstGroupName;
    disabilitaNavigazioneFrecce();
    if (isZoomed) {
        toggleZoom(); // Disattiva la lente quando si chiude l'overlay
    }
}

function navigateImages(direction) {
    const overlayImg = document.getElementById("overlayImg");
    const currentIndex = parseInt(overlayImg.dataset.index);
    const currentGroupImages = JSON.parse(overlayImg.dataset.group);

    let newIndex;

    if (direction === 1) {
        newIndex = currentIndex + 1;
        if (newIndex >= currentGroupImages.length) {
            const groupNames = Object.keys(imageGroups);
            const currentGroupName = document.querySelector(".image-group h2").textContent;
            const currentGroupIndex = groupNames.indexOf(currentGroupName);
            const nextGroupIndex = (currentGroupIndex + 1) % groupNames.length;
            const nextGroupName = groupNames[nextGroupIndex];
            const nextGroupImages = imageGroups[nextGroupName];
            overlayImg.src = thumbnailsPath + nextGroupImages[0];
            overlayImg.dataset.group = JSON.stringify(nextGroupImages);
            overlayImg.dataset.index = 0;
            document.querySelector(".image-group h2").textContent = nextGroupName;
            const spanElement = document.querySelector("span.pagenum");
            spanElement.textContent = "[" + nextGroupImages.length + "] " + nextGroupName;
        } else {
            overlayImg.src = thumbnailsPath + currentGroupImages[newIndex];
            overlayImg.dataset.index = newIndex;
            const spanElement = document.querySelector("span.pagenum");
            spanElement.textContent = "[" + nextGroupImages.length + "] " + nextGroupName;
        }
    } else if (direction === -1) {
        newIndex = currentIndex - 1;
        if (newIndex < 0) {
            const groupNames = Object.keys(imageGroups);
            const currentGroupName = document.querySelector(".image-group h2").textContent;
            const currentGroupIndex = groupNames.indexOf(currentGroupName);
            const prevGroupIndex = (currentGroupIndex - 1 + groupNames.length) % groupNames.length;
            const prevGroupName = groupNames[prevGroupIndex];
            const prevGroupImages = imageGroups[prevGroupName];
            overlayImg.src = thumbnailsPath + prevGroupImages[prevGroupImages.length - 1];
            overlayImg.dataset.group = JSON.stringify(prevGroupImages);
            overlayImg.dataset.index = prevGroupImages.length - 1;
            document.querySelector(".image-group h2").textContent = prevGroupName;
            const spanElement = document.querySelector("span.pagenum");
            spanElement.textContent = "[" + prevGroupImages.length + "] " + prevGroupName;
        } else {
            overlayImg.src = thumbnailsPath + currentGroupImages[newIndex];
            overlayImg.dataset.index = newIndex;
            const spanElement = document.querySelector("span.pagenum");
            spanElement.textContent = "[" + nextGroupImages.length + "] " + nextGroupName;
        }
    }
    handleIMGsize();
}

let eventListenerAdded = false;

function abilitaNavigazioneFrecce() {
    if (!eventListenerAdded) {
        window.addEventListener('keydown', gestisciPressioneTasto);
        eventListenerAdded = true;
    }
}

function disabilitaNavigazioneFrecce() {
    window.removeEventListener('keydown', gestisciPressioneTasto);
    eventListenerAdded = false;
}

function gestisciPressioneTasto(event) {
    if (event.key === "ArrowLeft") {
        navigateImages(-1);
    } else if (event.key === "ArrowRight") {
        navigateImages(1);
    }
}

const thumbnailsPath = "thumbnails/";

let imageGroups;

fetch('imageGroups.json')
    .then(response => response.json())
    .then(data => {
        imageGroups = data;
        createImageGroups();
    })
    .catch(error => {
        console.error('Si Ã¨ verificato un errore:', error);
    });

function createImageGroups() {
    const container = document.getElementById("imageContainer");

    for (const groupName in imageGroups) {
        const images = imageGroups[groupName];
        const groupDiv = document.createElement("div");
        groupDiv.classList.add("image-group");

        const heading = document.createElement("h2");
        heading.textContent = groupName;
        groupDiv.appendChild(heading);

        images.forEach((image, index) => {
            const img = document.createElement("img");
            img.src = thumbnailsPath + image;
            img.onclick = () => openOverlay(images, index, groupName);
            groupDiv.appendChild(img);
        });

        container.appendChild(groupDiv);
    }
}

function handleIMGsize() {
    const overlayImg = document.getElementById("overlayImg");
    const windowHeight = window.innerHeight;
    const elementHeight = overlayImg.offsetHeight;
    if (elementHeight > windowHeight * 0.8) {
        overlayImg.style.top = '55%';
        overlayImg.style.height = windowHeight;
    } else {
        overlayImg.style.top = '50%';
        overlayImg.style.height = '';
    }
}

document.getElementById("overlayImg").addEventListener("mousemove", handleMouseMove);
</script>
</body>
</html>
